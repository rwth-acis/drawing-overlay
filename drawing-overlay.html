<!--
@license
Copyright (c) 2015, RWTH Aachen University.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.


Based on the Polymer Seed Element Copyright (c) 2015 The Polymer Project Authors.
-->
<link rel="import" href="../polymer/polymer.html">

<script src="../d3/d3.js"></script>

<!--
A component to allow drawing on top of other elements.

Example:

    <drawing-overlay>
        <img src="http://placekitten.com/g/350/350">
    </drawing-overlay>

@demo
-->
<dom-module id="drawing-overlay">

    <style>

        :host {
            position: relative;
            display: block;
            box-sizing: border-box;
        }

        .content-wrapper > ::content {
            position: absolute;
            top: 0px;
            left: 0px;
        }

        path {
            fill: none;
            stroke: blue;
            stroke-width: 1px;
            stroke-linejoin: round;
            stroke-linecap: round;
        }

    </style>

    <template>
        <!--<div class="content-wrapper"><content></content></div>-->
        <svg id="drawingCanvas" viewBox="0 0 100 100" width="100%"></svg>
    </template>

</dom-module>

<script>

    Polymer({

        is: 'drawing-overlay',

        properties: {

            /**
             * `autoscale` indicates whether the canvas should be resized dynamically.
             * TODO: not yet implemented
             */
            autoscale: Boolean,

            /**
             * The width of the drawing.
             *
             * @default '350'
             */
            width: {
                type: Number,
                value: 350
            },

            /**
             * The height of the drawing.
             *
             * @default '350'
             */
            height: {
                type: Number,
                value: 350
            }
        },

        listeners: {
            'seed-element-lasers': 'sayHello'
        },

        // Element Lifecycle

        attached: function() {
            // because of shady DOM we have to assign the canvas a random ID otherwise fabric.js
            // finds only the first occurrence
            //var elem = this.querySelector("svg");
            //elem.id = this._guid();

            this._renderPath = d3.svg.line()
                    .x(function (d) { return d[0] })
                    .y(function (d) { return d[1] })
                    .interpolate('basis');

            this._svg = d3.select('svg')//'#\\' + elem.id)
                    .call(d3.behavior.drag()
                            .on('dragstart', this._dragstart.bind(this))
                            .on('drag', this._drag.bind(this))
                            .on('dragend', this._dragend.bind(this)));

        },

        // Element Behavior

        /**
         * The `drawing-overlay-path-created` event is fired whenever a path is created on the canvas.
         *
         * @event drawing-overlay-path-created
         * @detail {{object: Object}}
         */

        /**
         * The `drawing-overlay-path-appended` event is fired whenever a path is appendedon the canvas.
         *
         * @event drawing-overlay-path-appended
         * @detail {{object: Object}}
         */

        /**
         * Is called internally when a new path has been created on the canvas.
         */
        _canvasPathCreated: function(pathObject) {
            this.fire('drawing-overlay-path-created', {object: pathObject});
        },


        _canvasPathAppended: function(pathObject) {
            this.fire('drawing-overlay-path-appended', {object: pathObject});
        },


        /**
         * Gets the JSON representation of the drawing.
         *
         * @return {object} A JSON stringified object of the drawing.
         */
        toJSON: function() {
            //return this._canvas.toJSON();
        },

        /**
         * Loads the JSON of a complete drawing and puts it on the canvas.
         *
         * @param drawing
         * @returns {*|fabric.Canvas}
         */
        loadJSON: function(drawing) {
            //return this._canvas.loadFromJSON(drawing, this._canvas.renderAll.bind(this._canvas));
        },

        /**
         * Removes the drawing from the canvas.
         */
        clear: function() {
            this._svg.selectAll('path').remove()
        },

        /**
         * Adds a drawing object to the current drawing on the canvas.
         *
         * @param pathObject an array with vector values.
         */
        createPath: function(pathObject) {
            var line = this._svg.append('path').datum(pathObject.pathArray);
            line.attr('id', pathObject.id);
            line.attr('d', this._renderPath);
            this._currentPath.attr('class', 'style-scope drawing-overlay');
        },

        appendPath: function(pathObject) {
            //TODO: get path with the id and append its datum
        },

        _currentLine: null,
        _currentPath: null,
        _currentId: null,

        _dragstart: function() {
            this._currentLine = [];
            this._currentPath = null;
            this._currentId = this._guid();
        },

        // After one dragged event is recognized, we ignore them for 33ms.
        _ignoreDrag: null,

        _drag: function() {
            if (this._currentLine != null && this._ignoreDrag == null) {
                var that = this;
                this._ignoreDrag = window.setTimeout(function () {
                    that._ignoreDrag = null;
                }, 3);
                var coordinates = d3.mouse(this.$.drawingCanvas);

                this._currentLine.push(coordinates);

                var pathObject = {};
                pathObject.id = this._currentId;
                pathObject.pathArray = [coordinates];

                // now draw the path
                if (this._currentPath === null) {
                    this._currentPath = this._svg.append('path').datum([coordinates]);
                    this._currentPath.attr('d', this._renderPath);
                    this._currentPath.attr('class', 'style-scope drawing-overlay');
                    this._currentPath.attr('id', this._currentId);
                    this._canvasPathCreated(pathObject);
                } else {
                    this._currentPath.datum().push(coordinates);
                    this._currentPath.attr('d', this._renderPath);
                    this._canvasPathAppended(pathObject);
                }
            }
        },

        _dragend: function() {
            //this._drawLine(this._currentLine);
            this._currentLine = null;
            this._currentPath = null;
            window.clearTimeout(this._ignoreDrag);
            this._ignoreDrag = null;
        },

        _guid: function() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                s4() + '-' + s4() + s4() + s4();
        }

    });

</script>
